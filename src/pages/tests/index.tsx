import axios from "axios";
import { FC, useState } from "react";
import { LoaderFunction, LoaderFunctionArgs, useLoaderData, useNavigate } from "react-router-dom";
import TestCard from "../../components/TestCard";
import ConfirmationOverlay from "../../components/ConfirmationOverly";
import { useAuthStore } from "../../store/use-auth";

const Tests: FC = ({}) => {
  const navigate = useNavigate();
  const [showConfirmationOverlay, setSetShowConfirmationOverlay] = useState(false);
  const tests = useLoaderData() as { name: string; hexId: string }[];
  console.log(tests);
  const isLoggedIn = useAuthStore((state) => state.isLoggedIn);
  return (
    <div className="mt-5 lg:w-[50rem] sm:w-[30rem] mx-auto">
      {showConfirmationOverlay && (
        <ConfirmationOverlay
          setShowConfirmationOverlay={setSetShowConfirmationOverlay}
          onYes={() => {
            navigate("/login")
          }}
          onNo={() => {
            setSetShowConfirmationOverlay((prev) => !prev);
          }}
          message="You must be logged in to attempt this test."
          agreeMessage="Login"
          cancelMessgae="Cancel"
        />
      )}
      <div className="bg-[#282828] px-8 pt-8 pb-6 rounded-md border-[#383838] hover:border-[#484848] border-t-[1px] border-b-[1px] border-l-[1px] border-r-[1px]">
        <header className="text-2xl font-bold">Jee-Main Tests</header>
        <div>
          {tests.map(({ name, hexId }, index) => {
            let info;
            if (index % 2 === 0) {
              info = "Unattempted. Click to start test";
            } else {
              info = "Attempted. Click to view analysis";
            }
            const testButtonLink = `${hexId}/begin`;
            return (
              <TestCard
                onClickHandler={() => {
                  if (!isLoggedIn) {
                    setSetShowConfirmationOverlay(true);
                  } else {
                    navigate(testButtonLink);  
                  }
                }}
                testInfo={info}
                testName={name}
              />
            );
          })}
        </div>
        <div className="mt-1 flex justify-between items-center pt-4">
          <button className="bg-[#c75c54] hover:bg-[#de4c4a] px-4 py-2 rounded-md cursor-pointer">
            Previous
          </button>
          <button className="bg-[#c75c54] hover:bg-[#de4c4a] px-4 py-2 rounded-md cursor-pointer">
            Next
          </button>
        </div>
      </div>
    </div>
  );
};

export default Tests;

export const TestsLoader: LoaderFunction = async (_args: LoaderFunctionArgs) => {
  console.log("inside Tests.tsx loader");
  const response = await axios.get("http://localhost:8080/api/tests", { withCredentials: true });
  // console.log(response.data);
  return response.data;
};
